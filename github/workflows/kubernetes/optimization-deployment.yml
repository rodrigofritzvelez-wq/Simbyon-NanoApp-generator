# .kubernetes/optimization-deployment.yml
# K8s Deployment para el Optimization Service (Algoritmo KODI en Go)

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: optimization-service-deployment
  labels:
    app: optimization-service
    tier: core
spec:
  replicas: 3 # Mínimo de réplicas para alta disponibilidad
  selector:
    matchLabels:
      app: optimization-service
  template:
    metadata:
      labels:
        app: optimization-service
        tier: core
    spec:
      containers:
        - name: kodi-optimizer
          image: symbyon/kodi-optimizer:latest # Imagen compilada del Go Service
          ports:
            - containerPort: 8080
          resources:
            limits:
              cpu: "500m"
              memory: "1024Mi"
            requests:
              cpu: "250m"
              memory: "512Mi"
          env:
            - name: RABBITMQ_URI
              valueFrom:
                secretKeyRef:
                  name: simbyon-secrets
                  key: rabbitmq_uri
            - name: POSTGRES_URL
              valueFrom:
                secretKeyRef:
                  name: simbyon-secrets
                  key: postgres_url
          livenessProbe: # Verifica si el contenedor sigue vivo
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 15
            periodSeconds: 20
          readinessProbe: # Verifica si el servicio está listo para recibir tráfico
            httpGet:
              path: /ready
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: optimization-service-clusterip
spec:
  selector:
    app: optimization-service
  ports:
    - protocol: TCP
      port: 8080
      targetPort: 8080
  type: ClusterIP # Solo accesible internamente por el API Gateway

---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: optimization-service-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: optimization-service-deployment
  minReplicas: 3
  maxReplicas: 15 # Capacidad máxima de escalado para la simulación KODI
  metrics:
    # Estrategia de escalado crítica para los servicios asíncronos (KODI)
    - type: Pods
      # Escalar si la cola de RabbitMQ (Processing Queue) tiene más de 100 mensajes pendientes
      resource:
        name: rabbitmq_queue_depth
        target:
          type: AverageValue
          averageValue: 100 
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70 # Escalar si el uso promedio de CPU supera el 70%
