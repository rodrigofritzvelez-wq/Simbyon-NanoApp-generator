name: Simbyon NanoApp Generator CI/CD

# üéØ Eventos que disparan el workflow
on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

# ‚öôÔ∏è Variables de Entorno Globales (Simulaci√≥n)
env:
  NODE_VERSION: '20.x'
  PYTHON_VERSION: '3.11'
  GO_VERSION: '1.21.x'
  POSTGRES_HOST: localhost
  POSTGRES_DB: simbyon_db

# üëâ PUSH m√≠nimo para despertar Actions
# touch: workflow activated

# ‚öôÔ∏è Variables de Entorno Globales (Simulaci√≥n)
env:
  NODE_VERSION: '20.x'
  PYTHON_VERSION: '3.11'
  GO_VERSION: '1.21.x'
  POSTGRES_HOST: localhost
  POSTGRES_DB: simbyon_db

jobs:
  # ===================================================
  # 1. AUTH & NANOAPP SERVICE (Node.js/TypeScript SDK)
  # ===================================================
  build_node_services:
    name: Build & Test Node.js Services (Auth/NanoApp)
    runs-on: ubuntu-latest
    
    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: üì¶ Install Dependencies (Auth/NanoApp)
        # Asumiendo que los servicios Node.js est√°n en carpetas separadas
        run: |
          npm install
          # cd services/auth && npm install
          # cd ../nanoapp && npm install

      - name: ‚öôÔ∏è Run TypeScript Compilation (TSC)
        # Verifica la compilaci√≥n del SDK y los servicios
        run: npm run build
        
      - name: üß™ Run Unit and Integration Tests
        # Ejecuta pruebas para verificar la l√≥gica de NanoApp y Auth
        run: npm run test:ci

      - name: üîí Run Security Scan (e.g., Snyk/NPM Audit)
        run: npm audit --audit-level=high

  # ===================================================
  # 2. OPTIMIZATION SERVICE (Go/Golang)
  # ===================================================
  build_go_optimization:
    name: Build & Test Go Optimization Service
    runs-on: ubuntu-latest
    needs: build_node_services
    
    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Setup Go Environment
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: üì¶ Go Dependencies
        # Asumiendo que el c√≥digo Go est√° en services/optimization
        run: cd services/optimization && go mod download

      - name: üèóÔ∏è Go Build
        # Compila el ejecutable del servicio KODI
        run: cd services/optimization && go build -v ./...

      - name: üß™ Go Test
        # Ejecuta pruebas para los Algoritmos KODI y Adaptive Coherence Protocol
        run: cd services/optimization && go test -v ./...
        
  # ===================================================
  # 3. ANALYSIS SERVICE (Python)
  # ===================================================
  test_python_analysis:
    name: Test Python Analysis Service (ML Models)
    runs-on: ubuntu-latest
    needs: build_node_services
    
    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Setup Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: üì¶ Install Python Dependencies
        # Instala librer√≠as ML (TensorFlow, Scikit-learn, etc.)
        run: pip install -r services/analysis/requirements.txt

      - name: üß™ Run Python Tests (Analysis)
        # Verifica la l√≥gica de Detecci√≥n de Sistema y Coherence Score
        run: cd services/analysis && pytest
        
  # ===================================================
  # 4. INTEGRATION TEST & DEPLOYMENT PREP
  # ===================================================
  integration_tests:
    name: Integration Tests & DB Schema Check
    runs-on: ubuntu-latest
    needs: [build_node_services, build_go_optimization, test_python_analysis]
    
    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4
        
      - name: üêò Setup PostgreSQL
        # Inicia una instancia de PostgreSQL en el entorno de prueba
        uses: ankane/setup-postgres@v1
        with:
          postgres-version: 15
          database: ${{ env.POSTGRES_DB }}

      - name: üìê Run Database Migrations/Schema Check
        # Asegura que el esquema de PostgreSQL sea consistente
        run: ./scripts/run_migrations.sh

      - name: üß™ Run End-to-End Tests (Full Flow)
        # Ejecuta pruebas que usan el SDK para simular el flujo completo
        run: npm run test:e2e
